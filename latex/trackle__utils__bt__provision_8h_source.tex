\hypertarget{trackle__utils__bt__provision_8h_source}{}\doxysection{trackle\+\_\+utils\+\_\+bt\+\_\+provision.\+h}
\mbox{\hyperlink{trackle__utils__bt__provision_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#ifndef TRACKLE\_UTILS\_BT\_PROVISION\_H}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#define TRACKLE\_UTILS\_BT\_PROVISION\_H}}
\DoxyCodeLine{3 }
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include "{}nvs\_flash.h"{}}}
\DoxyCodeLine{5 }
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{trackle__utils__wifi_8h}{trackle\_utils\_wifi.h}}"{}}}
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{trackle__utils_8h}{trackle\_utils.h}}"{}}}
\DoxyCodeLine{8 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <wifi\_provisioning/manager.h>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <wifi\_provisioning/scheme\_ble.h>}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#define PROV\_MGR\_MAX\_RETRY\_CNT 2}}
\DoxyCodeLine{13 \textcolor{keywordtype}{int} \mbox{\hyperlink{trackle__utils__bt__provision_8h_aed35ae8c893bfcbe26113761cda92385}{prov\_retry\_num}} = 0;}
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{char} *BT\_TAG = \textcolor{stringliteral}{"{}trackle-\/utils-\/bt-\/provision"{}};}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{comment}{/* Event handler for catching system events */}}
\DoxyCodeLine{18 \textcolor{keyword}{static} \textcolor{keywordtype}{void} bt\_event\_handler(\textcolor{keywordtype}{void} *arg, esp\_event\_base\_t event\_base,}
\DoxyCodeLine{19                              int32\_t event\_id, \textcolor{keywordtype}{void} *event\_data)}
\DoxyCodeLine{20 \{}
\DoxyCodeLine{21     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{22     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}bt event\_handler: \%s \%d"{}}, event\_base, event\_id);}
\DoxyCodeLine{23     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{24 }
\DoxyCodeLine{25     \textcolor{keywordflow}{if} (event\_base == WIFI\_PROV\_EVENT)}
\DoxyCodeLine{26     \{}
\DoxyCodeLine{27         \textcolor{keywordflow}{switch} (event\_id)}
\DoxyCodeLine{28         \{}
\DoxyCodeLine{29         \textcolor{keywordflow}{case} WIFI\_PROV\_START:}
\DoxyCodeLine{30             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning started"{}});}
\DoxyCodeLine{31             \textcolor{keywordflow}{break};}
\DoxyCodeLine{32         \textcolor{keywordflow}{case} WIFI\_PROV\_CRED\_RECV:}
\DoxyCodeLine{33         \{}
\DoxyCodeLine{34             wifi\_sta\_config\_t *wifi\_sta\_cfg = (wifi\_sta\_config\_t *)event\_data;}
\DoxyCodeLine{35             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Received Wi-\/Fi credentials"{}}}
\DoxyCodeLine{36                              \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)tSSID     : \%s\(\backslash\)n\(\backslash\)tPassword : \%s"{}},}
\DoxyCodeLine{37                      (\textcolor{keyword}{const} \textcolor{keywordtype}{char} *)wifi\_sta\_cfg-\/>ssid,}
\DoxyCodeLine{38                      (\textcolor{keyword}{const} \textcolor{keywordtype}{char} *)wifi\_sta\_cfg-\/>password);}
\DoxyCodeLine{39             \textcolor{keywordflow}{break};}
\DoxyCodeLine{40         \}}
\DoxyCodeLine{41         \textcolor{keywordflow}{case} WIFI\_PROV\_CRED\_FAIL:}
\DoxyCodeLine{42         \{}
\DoxyCodeLine{43             wifi\_prov\_sta\_fail\_reason\_t *reason = (wifi\_prov\_sta\_fail\_reason\_t *)event\_data;}
\DoxyCodeLine{44             ESP\_LOGE(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning failed!\(\backslash\)n\(\backslash\)tReason : \%s"{}}}
\DoxyCodeLine{45                              \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)tPlease reset to factory and retry provisioning"{}},}
\DoxyCodeLine{46                      (*reason == WIFI\_PROV\_STA\_AUTH\_ERROR) ? \textcolor{stringliteral}{"{}Wi-\/Fi station authentication failed"{}} : \textcolor{stringliteral}{"{}Wi-\/Fi access-\/point not found"{}});}
\DoxyCodeLine{47 }
\DoxyCodeLine{48             \mbox{\hyperlink{trackle__utils__bt__provision_8h_aed35ae8c893bfcbe26113761cda92385}{prov\_retry\_num}}++;}
\DoxyCodeLine{49             \textcolor{keywordflow}{if} (\mbox{\hyperlink{trackle__utils__bt__provision_8h_aed35ae8c893bfcbe26113761cda92385}{prov\_retry\_num}} >= \mbox{\hyperlink{trackle__utils__bt__provision_8h_ab5ad58d01d83caba9783d625f7eb1222}{PROV\_MGR\_MAX\_RETRY\_CNT}})}
\DoxyCodeLine{50             \{}
\DoxyCodeLine{51                 ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Failed to connect with provisioned AP, reseting provisioned credentials and restarting..."{}});}
\DoxyCodeLine{52                 wifi\_config\_t wifi\_cfg = \{0\};}
\DoxyCodeLine{53                 esp\_err\_t err = esp\_wifi\_set\_config(WIFI\_IF\_STA, \&wifi\_cfg);}
\DoxyCodeLine{54                 \textcolor{keywordflow}{if} (err != ESP\_OK)}
\DoxyCodeLine{55                 \{}
\DoxyCodeLine{56                     ESP\_LOGE(BT\_TAG, \textcolor{stringliteral}{"{}Failed to set wifi config, 0x\%x"{}}, err);}
\DoxyCodeLine{57                 \}}
\DoxyCodeLine{58 }
\DoxyCodeLine{59                 xEventGroupSetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_acfe2df1dab131d83f22efc4dcc9c6374}{RESTART}});}
\DoxyCodeLine{60             \}}
\DoxyCodeLine{61 }
\DoxyCodeLine{62             \textcolor{keywordflow}{break};}
\DoxyCodeLine{63         \}}
\DoxyCodeLine{64         \textcolor{keywordflow}{case} WIFI\_PROV\_CRED\_SUCCESS:}
\DoxyCodeLine{65             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning successful"{}});}
\DoxyCodeLine{66             \textcolor{keywordflow}{break};}
\DoxyCodeLine{67         \textcolor{keywordflow}{case} WIFI\_PROV\_END:}
\DoxyCodeLine{68             \textcolor{comment}{// De-\/initialize manager once provisioning is finished and restart}}
\DoxyCodeLine{69             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning end"{}});}
\DoxyCodeLine{70             wifi\_prov\_mgr\_deinit();}
\DoxyCodeLine{71             xEventGroupSetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_acfe2df1dab131d83f22efc4dcc9c6374}{RESTART}});}
\DoxyCodeLine{72             \textcolor{keywordflow}{break};}
\DoxyCodeLine{73         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{74             \textcolor{keywordflow}{break};}
\DoxyCodeLine{75         \}}
\DoxyCodeLine{76     \}}
\DoxyCodeLine{77 }
\DoxyCodeLine{78     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}end bt\_event\_handler: -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{79 \}}
\DoxyCodeLine{80 }
\DoxyCodeLine{81 \textcolor{keyword}{static} \textcolor{keywordtype}{void} get\_device\_service\_name(\textcolor{keywordtype}{char} *service\_name, \textcolor{keywordtype}{size\_t} max)}
\DoxyCodeLine{82 \{}
\DoxyCodeLine{83     uint8\_t eth\_mac[6];}
\DoxyCodeLine{84     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *ssid\_prefix = \textcolor{stringliteral}{"{}DEVICE\_"{}};}
\DoxyCodeLine{85     esp\_wifi\_get\_mac(WIFI\_IF\_STA, eth\_mac);}
\DoxyCodeLine{86     snprintf(service\_name, max, \textcolor{stringliteral}{"{}\%s\%02X\%02X\%02X"{}}, ssid\_prefix, eth\_mac[3], eth\_mac[4], eth\_mac[5]);}
\DoxyCodeLine{87 \}}
\DoxyCodeLine{88 }
\DoxyCodeLine{89 \textcolor{keywordtype}{void} \mbox{\hyperlink{trackle__utils__bt__provision_8h_ae6ad309a638b1aaabc8a4e1f7a6df33c}{trackle\_utils\_bt\_provision\_init}}()}
\DoxyCodeLine{90 \{}
\DoxyCodeLine{91     ESP\_ERROR\_CHECK(esp\_event\_handler\_register(WIFI\_PROV\_EVENT, ESP\_EVENT\_ANY\_ID, \&bt\_event\_handler, NULL));}
\DoxyCodeLine{92 \}}
\DoxyCodeLine{93 }
\DoxyCodeLine{94 \textcolor{keywordtype}{void} \mbox{\hyperlink{trackle__utils__bt__provision_8h_a098ddae8c6f927c6e45a3be6ff8da634}{trackle\_utils\_bt\_provision\_loop}}()}
\DoxyCodeLine{95 \{}
\DoxyCodeLine{96     EventBits\_t bits = xEventGroupGetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}});}
\DoxyCodeLine{97 }
\DoxyCodeLine{98     \textcolor{comment}{// Check if start or stop provisioning}}
\DoxyCodeLine{99     \textcolor{keywordflow}{if} (bits \& \mbox{\hyperlink{trackle__utils_8h_a4e00f705d8c6b61ebf4470c4f5793cee}{START\_PROVISIONING}})}
\DoxyCodeLine{100     \{}
\DoxyCodeLine{101         xEventGroupClearBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_a4e00f705d8c6b61ebf4470c4f5793cee}{START\_PROVISIONING}});}
\DoxyCodeLine{102         xEventGroupSetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_a97524ff282c3231e0e60d5a484b489d4}{IS\_PROVISIONING}});}
\DoxyCodeLine{103 }
\DoxyCodeLine{104         esp\_wifi\_set\_ps(WIFI\_PS\_MIN\_MODEM); \textcolor{comment}{// enable powersave}}
\DoxyCodeLine{105 }
\DoxyCodeLine{106         \textcolor{comment}{// Configuration for the provisioning manager}}
\DoxyCodeLine{107         wifi\_prov\_mgr\_config\_t config = \{}
\DoxyCodeLine{108             .scheme = wifi\_prov\_scheme\_ble,}
\DoxyCodeLine{109             .scheme\_event\_handler = WIFI\_PROV\_SCHEME\_BLE\_EVENT\_HANDLER\_FREE\_BTDM,}
\DoxyCodeLine{110         \};}
\DoxyCodeLine{111 }
\DoxyCodeLine{112         \textcolor{comment}{// Initialize provisioning manager}}
\DoxyCodeLine{113         wifi\_prov\_mgr\_init(config);}
\DoxyCodeLine{114 }
\DoxyCodeLine{115         \textcolor{keywordtype}{char} service\_name[14];}
\DoxyCodeLine{116         get\_device\_service\_name(service\_name, \textcolor{keyword}{sizeof}(service\_name));}
\DoxyCodeLine{117 }
\DoxyCodeLine{118         wifi\_prov\_security\_t security = WIFI\_PROV\_SECURITY\_1;}
\DoxyCodeLine{119 }
\DoxyCodeLine{120         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *service\_key = NULL;}
\DoxyCodeLine{121         uint8\_t custom\_service\_uuid[] = \{0xb4, 0xdf, 0x5a, 0x1c, 0x3f, 0x6b, 0xf4, 0xbf, 0xea, 0x4a, 0x82, 0x03, 0x04, 0x90, 0x1a, 0x02\};}
\DoxyCodeLine{122         wifi\_prov\_scheme\_ble\_set\_service\_uuid(custom\_service\_uuid);}
\DoxyCodeLine{123 }
\DoxyCodeLine{124         esp\_err\_t prov\_err = wifi\_prov\_mgr\_start\_provisioning(security, NULL, service\_name, service\_key);}
\DoxyCodeLine{125         ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}wifi\_prov\_mgr\_start\_provisioning \%d"{}}, prov\_err);}
\DoxyCodeLine{126     \}}
\DoxyCodeLine{127 \}}
\DoxyCodeLine{128 }
\DoxyCodeLine{129 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
