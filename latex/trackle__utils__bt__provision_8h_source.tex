\hypertarget{trackle__utils__bt__provision_8h_source}{}\doxysection{trackle\+\_\+utils\+\_\+bt\+\_\+provision.\+h}
\mbox{\hyperlink{trackle__utils__bt__provision_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#ifndef TRACKLE\_UTILS\_BT\_PROVISION\_H}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#define TRACKLE\_UTILS\_BT\_PROVISION\_H}}
\DoxyCodeLine{3 }
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include "{}nvs\_flash.h"{}}}
\DoxyCodeLine{5 }
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{trackle__utils__wifi_8h}{trackle\_utils\_wifi.h}}"{}}}
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{trackle__utils__bt__functions_8h}{trackle\_utils\_bt\_functions.h}}"{}}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{trackle__utils_8h}{trackle\_utils.h}}"{}}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <wifi\_provisioning/manager.h>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <wifi\_provisioning/scheme\_ble.h>}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#define PROV\_MGR\_MAX\_RETRY\_CNT 2}}
\DoxyCodeLine{14 \textcolor{keywordtype}{int} \mbox{\hyperlink{trackle__utils__bt__provision_8h_aed35ae8c893bfcbe26113761cda92385}{prov\_retry\_num}} = 0;}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{char} *BT\_TAG = \textcolor{stringliteral}{"{}trackle-\/utils-\/bt-\/provision"{}};}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{comment}{/* Event handler for catching system events */}}
\DoxyCodeLine{19 \textcolor{keyword}{static} \textcolor{keywordtype}{void} bt\_event\_handler(\textcolor{keywordtype}{void} *arg, esp\_event\_base\_t event\_base,}
\DoxyCodeLine{20                              int32\_t event\_id, \textcolor{keywordtype}{void} *event\_data)}
\DoxyCodeLine{21 \{}
\DoxyCodeLine{22     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{23     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}bt event\_handler: \%s \%d"{}}, event\_base, event\_id);}
\DoxyCodeLine{24     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{25 }
\DoxyCodeLine{26     \textcolor{keywordflow}{if} (event\_base == WIFI\_PROV\_EVENT)}
\DoxyCodeLine{27     \{}
\DoxyCodeLine{28         \textcolor{keywordflow}{switch} (event\_id)}
\DoxyCodeLine{29         \{}
\DoxyCodeLine{30         \textcolor{keywordflow}{case} WIFI\_PROV\_START:}
\DoxyCodeLine{31             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning started"{}});}
\DoxyCodeLine{32             \textcolor{keywordflow}{break};}
\DoxyCodeLine{33         \textcolor{keywordflow}{case} WIFI\_PROV\_CRED\_RECV:}
\DoxyCodeLine{34         \{}
\DoxyCodeLine{35             wifi\_sta\_config\_t *wifi\_sta\_cfg = (wifi\_sta\_config\_t *)event\_data;}
\DoxyCodeLine{36             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Received Wi-\/Fi credentials"{}}}
\DoxyCodeLine{37                              \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)tSSID     : \%s\(\backslash\)n\(\backslash\)tPassword : \%s"{}},}
\DoxyCodeLine{38                      (\textcolor{keyword}{const} \textcolor{keywordtype}{char} *)wifi\_sta\_cfg-\/>ssid,}
\DoxyCodeLine{39                      (\textcolor{keyword}{const} \textcolor{keywordtype}{char} *)wifi\_sta\_cfg-\/>password);}
\DoxyCodeLine{40             \textcolor{keywordflow}{break};}
\DoxyCodeLine{41         \}}
\DoxyCodeLine{42         \textcolor{keywordflow}{case} WIFI\_PROV\_CRED\_FAIL:}
\DoxyCodeLine{43         \{}
\DoxyCodeLine{44             wifi\_prov\_sta\_fail\_reason\_t *reason = (wifi\_prov\_sta\_fail\_reason\_t *)event\_data;}
\DoxyCodeLine{45             ESP\_LOGE(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning failed!\(\backslash\)n\(\backslash\)tReason : \%s"{}}}
\DoxyCodeLine{46                              \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)tPlease reset to factory and retry provisioning"{}},}
\DoxyCodeLine{47                      (*reason == WIFI\_PROV\_STA\_AUTH\_ERROR) ? \textcolor{stringliteral}{"{}Wi-\/Fi station authentication failed"{}} : \textcolor{stringliteral}{"{}Wi-\/Fi access-\/point not found"{}});}
\DoxyCodeLine{48 }
\DoxyCodeLine{49             \mbox{\hyperlink{trackle__utils__bt__provision_8h_aed35ae8c893bfcbe26113761cda92385}{prov\_retry\_num}}++;}
\DoxyCodeLine{50             \textcolor{keywordflow}{if} (\mbox{\hyperlink{trackle__utils__bt__provision_8h_aed35ae8c893bfcbe26113761cda92385}{prov\_retry\_num}} >= \mbox{\hyperlink{trackle__utils__bt__provision_8h_ab5ad58d01d83caba9783d625f7eb1222}{PROV\_MGR\_MAX\_RETRY\_CNT}})}
\DoxyCodeLine{51             \{}
\DoxyCodeLine{52                 ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Failed to connect with provisioned AP, reseting provisioned credentials and restarting..."{}});}
\DoxyCodeLine{53                 wifi\_config\_t wifi\_cfg = \{0\};}
\DoxyCodeLine{54                 esp\_err\_t err = esp\_wifi\_set\_config(WIFI\_IF\_STA, \&wifi\_cfg);}
\DoxyCodeLine{55                 \textcolor{keywordflow}{if} (err != ESP\_OK)}
\DoxyCodeLine{56                 \{}
\DoxyCodeLine{57                     ESP\_LOGE(BT\_TAG, \textcolor{stringliteral}{"{}Failed to set wifi config, 0x\%x"{}}, err);}
\DoxyCodeLine{58                 \}}
\DoxyCodeLine{59 }
\DoxyCodeLine{60                 xEventGroupSetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_acfe2df1dab131d83f22efc4dcc9c6374}{RESTART}});}
\DoxyCodeLine{61             \}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63             \textcolor{keywordflow}{break};}
\DoxyCodeLine{64         \}}
\DoxyCodeLine{65         \textcolor{keywordflow}{case} WIFI\_PROV\_CRED\_SUCCESS:}
\DoxyCodeLine{66             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning successful"{}});}
\DoxyCodeLine{67             \textcolor{keywordflow}{break};}
\DoxyCodeLine{68         \textcolor{keywordflow}{case} WIFI\_PROV\_END:}
\DoxyCodeLine{69             \textcolor{comment}{// De-\/initialize manager once provisioning is finished and restart}}
\DoxyCodeLine{70             ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}Provisioning end"{}});}
\DoxyCodeLine{71             wifi\_prov\_mgr\_deinit();}
\DoxyCodeLine{72             xEventGroupSetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_acfe2df1dab131d83f22efc4dcc9c6374}{RESTART}});}
\DoxyCodeLine{73             \textcolor{keywordflow}{break};}
\DoxyCodeLine{74         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{75             \textcolor{keywordflow}{break};}
\DoxyCodeLine{76         \}}
\DoxyCodeLine{77     \}}
\DoxyCodeLine{78 }
\DoxyCodeLine{79     ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}end bt\_event\_handler: -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}});}
\DoxyCodeLine{80 \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82 \textcolor{keyword}{static} \textcolor{keywordtype}{void} get\_device\_service\_name(\textcolor{keywordtype}{char} *service\_name, \textcolor{keywordtype}{size\_t} max)}
\DoxyCodeLine{83 \{}
\DoxyCodeLine{84     uint8\_t eth\_mac[6];}
\DoxyCodeLine{85     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *ssid\_prefix = \textcolor{stringliteral}{"{}DEVICE\_"{}};}
\DoxyCodeLine{86     esp\_wifi\_get\_mac(WIFI\_IF\_STA, eth\_mac);}
\DoxyCodeLine{87     snprintf(service\_name, max, \textcolor{stringliteral}{"{}\%s\%02X\%02X\%02X"{}}, ssid\_prefix, eth\_mac[3], eth\_mac[4], eth\_mac[5]);}
\DoxyCodeLine{88 \}}
\DoxyCodeLine{89 }
\DoxyCodeLine{90 \textcolor{keywordtype}{void} \mbox{\hyperlink{trackle__utils__bt__provision_8h_ae6ad309a638b1aaabc8a4e1f7a6df33c}{trackle\_utils\_bt\_provision\_init}}()}
\DoxyCodeLine{91 \{}
\DoxyCodeLine{92     ESP\_ERROR\_CHECK(esp\_event\_handler\_register(WIFI\_PROV\_EVENT, ESP\_EVENT\_ANY\_ID, \&bt\_event\_handler, NULL));}
\DoxyCodeLine{93 \}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95 \textcolor{keywordtype}{void} \mbox{\hyperlink{trackle__utils__bt__provision_8h_a098ddae8c6f927c6e45a3be6ff8da634}{trackle\_utils\_bt\_provision\_loop}}()}
\DoxyCodeLine{96 \{}
\DoxyCodeLine{97     EventBits\_t bits = xEventGroupGetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}});}
\DoxyCodeLine{98 }
\DoxyCodeLine{99     \textcolor{comment}{// Check if start or stop provisioning}}
\DoxyCodeLine{100     \textcolor{keywordflow}{if} (bits \& \mbox{\hyperlink{trackle__utils_8h_a4e00f705d8c6b61ebf4470c4f5793cee}{START\_PROVISIONING}})}
\DoxyCodeLine{101     \{}
\DoxyCodeLine{102         xEventGroupClearBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_a4e00f705d8c6b61ebf4470c4f5793cee}{START\_PROVISIONING}});}
\DoxyCodeLine{103         xEventGroupSetBits(\mbox{\hyperlink{trackle__utils_8h_a6aaca350cca4b3d105d88a6f399cb381}{s\_wifi\_event\_group}}, \mbox{\hyperlink{trackle__utils_8h_a97524ff282c3231e0e60d5a484b489d4}{IS\_PROVISIONING}});}
\DoxyCodeLine{104 }
\DoxyCodeLine{105         esp\_wifi\_set\_ps(WIFI\_PS\_MIN\_MODEM); \textcolor{comment}{// enable powersave}}
\DoxyCodeLine{106 }
\DoxyCodeLine{107         \textcolor{comment}{// Configuration for the provisioning manager}}
\DoxyCodeLine{108         wifi\_prov\_mgr\_config\_t config = \{}
\DoxyCodeLine{109             .scheme = wifi\_prov\_scheme\_ble,}
\DoxyCodeLine{110             .scheme\_event\_handler = WIFI\_PROV\_SCHEME\_BLE\_EVENT\_HANDLER\_FREE\_BTDM,}
\DoxyCodeLine{111         \};}
\DoxyCodeLine{112 }
\DoxyCodeLine{113         \textcolor{comment}{// Initialize provisioning manager}}
\DoxyCodeLine{114         wifi\_prov\_mgr\_init(config);}
\DoxyCodeLine{115 }
\DoxyCodeLine{116         \mbox{\hyperlink{trackle__utils__bt__functions_8h_a8faf9bcc20248123159522c676d8fbc3}{btFunctionsEndpointsCreate}}();}
\DoxyCodeLine{117 }
\DoxyCodeLine{118         \textcolor{keywordtype}{char} service\_name[14];}
\DoxyCodeLine{119         get\_device\_service\_name(service\_name, \textcolor{keyword}{sizeof}(service\_name));}
\DoxyCodeLine{120 }
\DoxyCodeLine{121         wifi\_prov\_security\_t security = WIFI\_PROV\_SECURITY\_1;}
\DoxyCodeLine{122 }
\DoxyCodeLine{123         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *service\_key = NULL;}
\DoxyCodeLine{124         uint8\_t custom\_service\_uuid[] = \{0xb4, 0xdf, 0x5a, 0x1c, 0x3f, 0x6b, 0xf4, 0xbf, 0xea, 0x4a, 0x82, 0x03, 0x04, 0x90, 0x1a, 0x02\};}
\DoxyCodeLine{125         wifi\_prov\_scheme\_ble\_set\_service\_uuid(custom\_service\_uuid);}
\DoxyCodeLine{126 }
\DoxyCodeLine{127         esp\_err\_t prov\_err = wifi\_prov\_mgr\_start\_provisioning(security, NULL, service\_name, service\_key);}
\DoxyCodeLine{128         ESP\_LOGI(BT\_TAG, \textcolor{stringliteral}{"{}wifi\_prov\_mgr\_start\_provisioning \%d"{}}, prov\_err);}
\DoxyCodeLine{129         \mbox{\hyperlink{trackle__utils__bt__functions_8h_a4625feaca2e20f96816b7e278b9cf26f}{btFunctionsEndpointsRegister}}();}
\DoxyCodeLine{130     \}}
\DoxyCodeLine{131 \}}
\DoxyCodeLine{132 }
\DoxyCodeLine{133 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
